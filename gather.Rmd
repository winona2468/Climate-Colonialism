---
title: "Climate Colonialism: Gather.Rmd"
author: "Winona Guo"
date: "10/14/2020"
output: html_document
---

These are my datasets:
  
1) Colonial History Dataset
https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/5EMETG

2) Measuring the Impacts of Colonialism: A New Data Set for the Countries of Africa and Asia
https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/UQZFYA

3) Countries Vulnerable to the Climate
https://www.cgdev.org/publication/dataset-vulnerability-climate-change

4) C02 Emissions Per Country
https://github.com/datasets/co2-fossil-by-nation

Planning out my sitemap:

1) The Challenge
2) History of Empire
3) Emissions vs. Effects
4) Model
5) About

Below are resources that were helpful to reference as I made this project:

https://shiny.rstudio.com/reference/shiny/1.5.0/
https://shiny.rstudio.com/tutorial/
https://github.com/wyatthurt/gov-50-class-scripts/blob/main/class-2020-09-22/week_3_A.Rmd
https://rdrr.io/cran/maptools/man/wrld_simpl.html
https://www.davidkane.info/files/final_projects.html
https://github.com/wyatthurt/transboundary-water-conflict/tree/master/shiny_app
https://www.r-graph-gallery.com/

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(shiny)
library(shinythemes)
library(tidyverse)
library(janitor)

# Janitor is used to the clean the names within my data.

library(readr)
library(readxl)
library(leaflet)
library(maptools)
library(rgdal)
library(dplyr)
library(tidymodels)
library(rstanarm)
library(gt)
library(broom.mixed)

```

```{r Loading Data}

colonialism <- read_xls("shiny_app/raw_data/colonialism.xls") %>%
  clean_names() 

climaterisk <- read_xls("shiny_app/raw_data/vulnerability.xls", skip = 2) %>%
  clean_names() %>%
  rename(vulnerable = climate_vulnerability_cv_cdi_adj_for_income_regulation) %>%
  rename(governance = kkm_regulatory_quality_score_2008) %>%
  rename(income = income_per_capita_us_ppp_2008) %>%
  rename(area = area_sq_km) %>%
  mutate(country = str_to_title(country)) %>%
  select(country, vulnerable, income, governance, area, world_sub_region) %>%
  mutate(country = recode(country, 'Korea, Rep.' = 'Korea, Republic of',
                          "Korea, Dem. Rep." = "Korea, Democratic People's Republic of",
                          'Taiwan (China)' = 'Taiwan',
                          'Antigua And Barbuda' = 'Antigua and Barbuda',
                          'Bahamas, The' = 'Bahamas',
                          'Slovak Republic' = 'Slovakia',

                          # Starting here are the ones I am renaming so that it aligns with the wrldsimplmod countries' names. 

                          'Iran, Islamic Rep.' = 'Iran (Islamic Republic of)',
                          'Bosnia And Herzegovina' = 'Bosnia and Herzegovina',
                          'Myanmar' = 'Burma',
                          'Congo, Rep.' = 'Congo',
                          'Congo, Dem. Rep.' = 'Democratic Republic of the Congo',
                          'Egypt, Arab Rep.' = 'Egypt',
                          'Yemen, Rep.' = 'Yemen',
                          'French Guians' = 'French Guiana',
                          'Micronesia, Fed. Sts.' = 'Micronesia, Federated States of',
                          'Gambia, The' = 'Gambia',
                          "Cote D'ivoire" = "Cote d'Ivoire",
                          'Kyrgyz Republic' = 'Kyrgyzstan',
                          'Falkland Islands' = 'Falkland Islands (Malvinas)',
                          "Lao Pdr" = "Lao People's Democratic Republic",
                          'Libya' = 'Libyan Arab Jamahiriya',
                          'Macedonia, Fyr' = 'The former Yugoslav Republic of Macedonia',
                          'Hong Kong Sar, China' = 'Hong Kong',
                          'Isle Of Man' = 'Isle of Man',
                          'Macao Sar, China' = 'Macau',
                          'West Bank And Gaza' = 'Palestine',
                          
                          # I feel somewhat like I am simplifying decades of history into one line of code!
                          
                          'Serbia And Montenegro' = 'Serbia',
                          'Moldova' = 'Republic of Moldova',
                          'Russian Federation' = 'Russia',
                          'St. Kitts And Nevis' = 'Saint Kitts and Nevis',
                          'St. Lucia' = 'Saint Lucia',
                          'Trinidad And Tobago' = 'Trinidad and Tobago',
                          'Sao Tome And Principe' = 'Sao Tome and Principe',
                          'Tanzania' = 'United Republic of Tanzania',
                          'St. Vincent And The Grenadines' = 'Saint Vincent and the Grenadines',
                          'Venezuela, Rb' = 'Venezuela',
                          'Vietnam' = 'Viet Nam',
                          'Virgin Islands (U.s.)' = 'United States Virgin Islands',
                          'Wallis And Futuna' = 'Wallis and Futuna Islands',
                          'Pitcairn' = 'Pitcairn Islands',
                          'St. Pierre And Miquelon' = 'Saint Pierre and Miquelon',
                          'St. Helena' = 'Saint Helena',
                          'Turks And Caicos Islands' = 'Turks and Caicos Islands',
                          'Svalbard And Jan Mayen' = 'Svalbard')) %>%
    mutate(vulnerable = replace(vulnerable, 188, 42.000))

# BIG IMPORTANT NOTE: I replaced Somalia's 100.000 climate risk rate with 42.000 (near Burma's), because it is a single dramatic outlier that changes the later graph. I will be sure to note this via text inside my Shiny app!

# Mapping these data sets (and doing the corresponding recoding work) requires navigating a lot of complex history that I'm having difficulty summarizing into one number. For instance, in the countries data, we have Yemen listed as being decolonized in 1990, but Yemen Peopleâ€™s Republic decolonized in 1967. In the climate data, there is one one 'Yemen Rep.' Which name maps on to which? I ended up choosing to rename Yemen Rep. as Yemen, both to match the later colonization date and also to match wrldsimplmod.

countries <- read_xls("shiny_app/raw_data/countries_files/icowcol.xls") %>%
  mutate(date = str_sub(Indep, 1, 4)) %>%
  mutate(twenty = ifelse(date >= 1900, "Colonized", "Independent")) %>%
  mutate(Name = recode(Name, 'United States of America' = 'United States',
                       'Tunisia (postcolonial)' = 'Tunisia',
                       'St. Kitts and Nevis' = 'Saint Kitts and Nevis',
                       'St. Vincent and the Grenadines' ='Saint Vincent and the Grenadines',
                       'Prussia / Germany' = 'Germany',
                       'Fed. States of Micronesia' = 'Micronesia, Federated States of',
                       'Iran' = 'Iran (Islamic Republic of)',
                       'Brunei' = 'Brunei Darussalam',
                       'Austria-Hungary' = 'Austria',
                       "Laos" = "Lao People's Democratic Republic",
                       'Egypt (poat-colonial)' = 'Egypt',
                       'South Korea' = 'Korea, Republic of',
                       "Korea, Dem. Rep." = "Korea, Democratic People's Republic of",
                       'Moldova' = 'Republic of Moldova',
                       'Serbia / Yugoslavia' = 'Serbia',
                       'Tanzania' = 'United Republic of Tanzania',
                       'Vietnam' = 'Viet Nam'))

emissions <- read_csv("shiny_app/raw_data/emissions.csv", 
                      col_types = cols(
                        Year = col_double(),
                        Country = col_character(),
                        Total = col_double(),
                        `Solid Fuel` = col_double(),
                        `Liquid Fuel` = col_double(),
                        `Gas Fuel` = col_double(),
                        Cement = col_double(),
                        `Gas Flaring` = col_double(),
                        `Per Capita` = col_double(),
                        `Bunker fuels (Not in Total)` = col_double()
                      )) %>%
  group_by(Country) %>%
  mutate(sum = sum(Total)) %>%
  slice(1) %>%
  select(Country, sum) %>%
  mutate(Country = str_to_title(Country)) %>%
  mutate(Country = recode(Country, "United States Of America" = "United States",
                          "China (Mainland)" = "China",
                          "Russian Federation" = "Russia",
                          "Islamic Republic Of Iran" = "Iran (Islamic Republic of)",
                          "Plurinational State Of Bolivia" = "Bolivia",
                          "Myanmar (Formerly Burma)" = "Burma",
                          "United Republic Of Tanzania" = "United Republic of Tanzania",
                          "Libyan Arab Jamahiriyah" = "Libyan Arab Jamahiriya",
                          "French West Africa" = "Western Sahara",
                          "Cote D Ivoire" = "Cote d'Ivoire",
                          "Republic Of Cameroon" = "Cameroon",
                          "Democratic Republic Of The Congo (Formerly Zaire)" = "Democratic Republic of the Congo",
                          "United Republic Of Tanzania" = "United Republic of Tanzania",
                          "Lao People S Democratic Republic" = "Lao People's Democratic Republic",
                          "Republic Of Korea" = "Korea, Republic of", 
                          "Democratic People S Republic Of Korea" = "Korea, Democratic People's Republic of",
                          "Antarctic Fisheries" = "Antarctica",
                          "France (Including Monaco)" = "France",
                          "Italy (Including San Marino)" = "Italy")) %>%
    mutate(sum = ifelse(sum == 102510260, 60000000, sum))

# BIG IMPORTANT NOTE AGAIN: I replaced the U.S. total emissions of 102510260, a dramatic outlier, to be 60,000,000, closer to the second largest # of 47649834 (China). 

# The below joins the colonialism data with climate risk data. 

fit_mod <- inner_join(countries, climaterisk, by = c("Name" = "country")) %>%
 group_by(twenty) %>%
 mutate(avg_risk = mean(vulnerable)) 

```

```{r Tab 1 Plot}

# Count(twenty) yields 131 colonized and 45 independent countries.

bar_graph <- fit_mod %>%
 select(twenty, avg_risk) %>%
 slice(1) %>%
 ggplot(mapping = aes(x = twenty, y = avg_risk)) + 
 geom_col(fill = "darkgreen") +
 labs(title = "Climate Risk Today for Countries Colonized vs. Independent", 
      subtitle = "At The Turn of the 20th Century", 
      x = "Countries' Colonial Status in 1900",
      y = "Average Climate Vulnerability Today",
      caption = "The average climate risk for colonized countries is 4.58, 
      and the average for independent countries is 1.52.") +
 theme_classic()

bar_graph

```

``` {r Tab 2 Plots}

# PLOT 1: COLONIALISM & INCOME

#graph onset and end of colonialism for different countries
#graph the 4 variables change over that period
#graph france vs. uk whether they have different effects on climate risk


#countries on left, geomline line segments on y from onset/end, color coded by motherland

#renacohen.shinyapps.io/afta/
 # https://benalexkeen.com/creating-a-timeline-graphic-using-r-and-ggplot2/

#look at rena's shiny app for modeling results

# PLOT 2: NUMBER OF YEARS COLONIZED (African and Asian Countries)

q1 <- colonialism %>%
  select(country_name, colyears) 

q2 <- climaterisk %>%
  select(country, vulnerable, world_sub_region) %>%
  subset(country != "Somalia") %>%
  subset(country != "Burundi")

# I removed these two outliers because they were so extreme that the rest of the graph was difficult to decipher.

q3 <- inner_join(q1, q2, by = c("country_name" = "country")) 

colonize <- q3 %>%
  ggplot(aes(x = colyears, y = vulnerable, color = world_sub_region)) +
  geom_point(alpha = 0.7) +
  labs(title = "Countries by Years Colonized and Vulnerability to Climate Risk",
       x = "Years Colonized",
       y = "Vulnerability to Climate Risk",
       caption = "This graph indicates there is not a significant correlation
       overall between the years a country has been colonized, 
       and its current vulnerability to climate risk.") +
  theme_bw() + 
  scale_color_discrete("World Region")

# PLOT: TYPE OF INDEPENCE (x) ON CLIMATE RISK (y)
      
    types <- fit_mod %>%
      ggplot(aes(x = Type, y = vulnerable)) +
      geom_col(fill = "orange") +
      labs(title = "The Effect of Different Types of Colonialism on Climate Risk",
           y = "Climate Risk",
           subtitle = "Key: 1 = Formation, 2 = Decolonization, 3 = Secession, 4 = Partition",
           caption = "This graph shows that decolonialization and occuption by a foreign power 
           has a significantly greater effect on risk than histories of secession or partition.") 
    
    types
    

```
```{r Tab 3 Leaflet}

# Modifying Polygons: world countries from the maptools package.

data(wrld_simpl)

wrldsimplmod <- wrld_simpl

# Merging with my data on climate risk. Unfortunately some countries are left with NA's because there is no climate risk data. An example: the South Georgia South Sandwich Islands!

wrldsimplmod@data <-
  
   left_join(wrld_simpl@data, climaterisk, by = c("NAME" = "country"))

saveRDS(wrldsimplmod, "shiny_app/joined.rds")

# Making for the second graph.

secondmod <- wrld_simpl

secondmod@data <-
  
   left_join(wrld_simpl@data, emissions, by = c("NAME" = "Country"))

saveRDS(secondmod, "shiny_app/joined2.rds")

```

```{r Tab 4 Model}

# Is there a predictive relationship between CO2 emissions and climate risk?

# Trying to produce total emissions for each country between 1751 and 2014. 

model <- inner_join(emissions, climaterisk, by = c("Country" = "country"))

model %>%
  ggplot(aes(x = sum, y = vulnerable)) +
  geom_smooth(method = "lm") +
  scale_x_log10() +
  scale_y_log10()

# possibly do checkboxes to give people choices
#show geom point not smooth to show variability
#specify these r countries that have been colonized (look back at 'model' what is missing). i see little correlation because...

# not 1 x 10^7 but log 1 x 10^7

# I am also controlling for three variables from each country here: income per capita, area, and governance quality. This data was included inside the climate risk dataset.

reg <- stan_glm(formula = vulnerable ~ sum + income + area + governance,
                data = model, 
                refresh = 0, 
                seed = 8) %>%
  tidy()

# create model with 0 and 1 as colonized vs indepdent. run that on climate risk - start here! if i add twenty column it will convert for me!!!!!!!!!!

# include model tibble via renderDataTable in shinyapp (see wyatt's first page!)


```

* Write the math for this model. I am considering risk as a function of emissions. How much should/do emissions affect risk?

$$ reg_{risk} = \beta_0 + \beta_1x_{emissions, i} + \epsilon $$
















